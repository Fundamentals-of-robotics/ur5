<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ur5: ClearML Integration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ur5
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">ClearML Integration</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md64"></a> <img src="https://github.com/thepycoder/clearml_screenshots/raw/main/logos_dark.png#gh-light-mode-only" alt="Clear|ML" align="center" class="inline"/><img src="https://github.com/thepycoder/clearml_screenshots/raw/main/logos_light.png#gh-dark-mode-only" alt="Clear|ML" align="center" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md65"></a>
About ClearML</h1>
<p><a href="https://cutt.ly/yolov5-tutorial-clearml">ClearML</a> is an <a href="https://github.com/allegroai/clearml">open-source</a> toolbox designed to save you time ‚è±Ô∏è.</p>
<p>üî® Track every YOLOv5 training run in the <b>experiment manager</b></p>
<p>üîß Version and easily access your custom training data with the integrated ClearML <b>Data Versioning Tool</b></p>
<p>üî¶ <b>Remotely train and monitor</b> your YOLOv5 training runs using ClearML Agent</p>
<p>üî¨ Get the very best mAP using ClearML <b>Hyperparameter Optimization</b></p>
<p>üî≠ Turn your newly trained <b>YOLOv5 model into an API</b> with just a few commands using ClearML Serving</p>
<p><br  />
 And so much more. It's up to you how many of these tools you want to use, you can stick to the experiment manager, or chain them all together into an impressive pipeline! <br  />
 <br  />
</p>
<p><img src="https://github.com/thepycoder/clearml_screenshots/raw/main/experiment_manager_with_compare.gif" alt="ClearML scalars dashboard" class="inline"/></p>
<p><br  />
 <br  />
</p>
<h1><a class="anchor" id="autotoc_md66"></a>
ü¶æ Setting Things Up</h1>
<p>To keep track of your experiments and/or data, ClearML needs to communicate to a server. You have 2 options to get one:</p>
<p>Either sign up for free to the <a href="https://cutt.ly/yolov5-tutorial-clearml">ClearML Hosted Service</a> or you can set up your own server, see <a href="https://clear.ml/docs/latest/docs/deploying_clearml/clearml_server">here</a>. Even the server is open-source, so even if you're dealing with sensitive data, you should be good to go!</p>
<ol type="1">
<li><p class="startli">Install the <code>clearml</code> python package:</p>
<div class="fragment"><div class="line">pip install clearml</div>
</div><!-- fragment --></li>
<li><p class="startli">Connect the ClearML SDK to the server by <a href="https://app.clear.ml/settings/workspace-configuration">creating credentials</a> (go right top to Settings -&gt; Workspace -&gt; Create new credentials), then execute the command below and follow the instructions:</p>
<div class="fragment"><div class="line">clearml-init</div>
</div><!-- fragment --></li>
</ol>
<p>That's it! You're done üòé</p>
<p><br  />
</p>
<h1><a class="anchor" id="autotoc_md67"></a>
üöÄ Training YOLOv5 With ClearML</h1>
<p>To enable ClearML experiment tracking, simply install the ClearML pip package.</p>
<div class="fragment"><div class="line">pip install clearml&gt;=1.2.0</div>
</div><!-- fragment --><p>This will enable integration with the YOLOv5 training script. Every training run from now on, will be captured and stored by the ClearML experiment manager.</p>
<p>If you want to change the <code>project_name</code> or <code>task_name</code>, use the <code>--project</code> and <code>--name</code> arguments of the <code>train.py</code> script, by default the project will be called <code>YOLOv5</code> and the task <code>Training</code>. PLEASE NOTE: ClearML uses <code>/</code> as a delimiter for subprojects, so be careful when using <code>/</code> in your project name!</p>
<div class="fragment"><div class="line">python train.py --img 640 --batch 16 --epochs 3 --data coco128.yaml --weights yolov5s.pt --cache</div>
</div><!-- fragment --><p>or with custom project and task name:</p>
<div class="fragment"><div class="line">python train.py --project my_project --name my_training --img 640 --batch 16 --epochs 3 --data coco128.yaml --weights yolov5s.pt --cache</div>
</div><!-- fragment --><p>This will capture:</p>
<ul>
<li>Source code + uncommitted changes</li>
<li>Installed packages</li>
<li>(Hyper)parameters</li>
<li>Model files (use <code>--save-period n</code> to save a checkpoint every n epochs)</li>
<li>Console output</li>
<li>Scalars (mAP_0.5, mAP_0.5:0.95, precision, recall, losses, learning rates, ...)</li>
<li>General info such as machine details, runtime, creation date etc.</li>
<li>All produced plots such as label correlogram and confusion matrix</li>
<li>Images with bounding boxes per epoch</li>
<li>Mosaic per epoch</li>
<li>Validation images per epoch</li>
<li>...</li>
</ul>
<p>That's a lot right? ü§Ø Now, we can visualize all of this information in the ClearML UI to get an overview of our training progress. Add custom columns to the table view (such as e.g. mAP_0.5) so you can easily sort on the best performing model. Or select multiple experiments and directly compare them!</p>
<p>There even more we can do with all of this information, like hyperparameter optimization and remote execution, so keep reading if you want to see how that works!</p>
<p><br  />
</p>
<h1><a class="anchor" id="autotoc_md68"></a>
üîó Dataset Version Management</h1>
<p>Versioning your data separately from your code is generally a good idea and makes it easy to acquire the latest version too. This repository supports supplying a dataset version ID, and it will make sure to get the data if it's not there yet. Next to that, this workflow also saves the used dataset ID as part of the task parameters, so you will always know for sure which data was used in which experiment!</p>
<p><img src="https://github.com/thepycoder/clearml_screenshots/raw/main/clearml_data.gif" alt="ClearML Dataset Interface" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md69"></a>
Prepare Your Dataset</h2>
<p>The YOLOv5 repository supports a number of different datasets by using yaml files containing their information. By default datasets are downloaded to the <code>../datasets</code> folder in relation to the repository root folder. So if you downloaded the <code>coco128</code> dataset using the link in the yaml or with the scripts provided by yolov5, you get this folder structure:</p>
<div class="fragment"><div class="line">..</div>
<div class="line">|_ yolov5</div>
<div class="line">|_ datasets</div>
<div class="line">    |_ coco128</div>
<div class="line">        |_ images</div>
<div class="line">        |_ labels</div>
<div class="line">        |_ LICENSE</div>
<div class="line">        |_ README.txt</div>
</div><!-- fragment --><p>But this can be any dataset you wish. Feel free to use your own, as long as you keep to this folder structure.</p>
<p>Next, ‚ö†Ô∏è**copy the corresponding yaml file to the root of the dataset folder**‚ö†Ô∏è. This yaml files contains the information ClearML will need to properly use the dataset. You can make this yourself too, of course, just follow the structure of the example yamls.</p>
<p>Basically we need the following keys: <code>path</code>, <code>train</code>, <code>test</code>, <code>val</code>, <code>nc</code>, <code>names</code>.</p>
<div class="fragment"><div class="line">..</div>
<div class="line">|_ yolov5</div>
<div class="line">|_ datasets</div>
<div class="line">    |_ coco128</div>
<div class="line">        |_ images</div>
<div class="line">        |_ labels</div>
<div class="line">        |_ coco128.yaml  # &lt;---- HERE!</div>
<div class="line">        |_ LICENSE</div>
<div class="line">        |_ README.txt</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md70"></a>
Upload Your Dataset</h2>
<p>To get this dataset into ClearML as a versioned dataset, go to the dataset root folder and run the following command:</p>
<div class="fragment"><div class="line">cd coco128</div>
<div class="line">clearml-data sync --project YOLOv5 --name coco128 --folder .</div>
</div><!-- fragment --><p>The command <code>clearml-data sync</code> is actually a shorthand command. You could also run these commands one after the other:</p>
<div class="fragment"><div class="line"># Optionally add --parent &lt;parent_dataset_id&gt; if you want to base</div>
<div class="line"># this version on another dataset version, so no duplicate files are uploaded!</div>
<div class="line">clearml-data create --name coco128 --project YOLOv5</div>
<div class="line">clearml-data add --files .</div>
<div class="line">clearml-data close</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md71"></a>
Run Training Using A ClearML Dataset</h2>
<p>Now that you have a ClearML dataset, you can very simply use it to train custom YOLOv5 üöÄ models!</p>
<div class="fragment"><div class="line">python train.py --img 640 --batch 16 --epochs 3 --data clearml://&lt;your_dataset_id&gt; --weights yolov5s.pt --cache</div>
</div><!-- fragment --><p><br  />
</p>
<h1><a class="anchor" id="autotoc_md72"></a>
üëÄ Hyperparameter Optimization</h1>
<p>Now that we have our experiments and data versioned, it's time to take a look at what we can build on top!</p>
<p>Using the code information, installed packages and environment details, the experiment itself is now <b>completely reproducible</b>. In fact, ClearML allows you to clone an experiment and even change its parameters. We can then just rerun it with these new parameters automatically, this is basically what HPO does!</p>
<p>To <b>run hyperparameter optimization locally</b>, we've included a pre-made script for you. Just make sure a training task has been run at least once, so it is in the ClearML experiment manager, we will essentially clone it and change its hyperparameters.</p>
<p>You'll need to fill in the ID of this <code>template task</code> in the script found at <code><a class="el" href="clearml_2hpo_8py.html">utils/loggers/clearml/hpo.py</a></code> and then just run it :) You can change <code>task.execute_locally()</code> to <code>task.execute()</code> to put it in a ClearML queue and have a remote agent work on it instead.</p>
<div class="fragment"><div class="line"># To use optuna, install it first, otherwise you can change the optimizer to just be RandomSearch</div>
<div class="line">pip install optuna</div>
<div class="line">python utils/loggers/clearml/hpo.py</div>
</div><!-- fragment --><p><img src="https://github.com/thepycoder/clearml_screenshots/raw/main/hpo.png" alt="HPO" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md73"></a>
ü§Ø Remote Execution (advanced)</h1>
<p>Running HPO locally is really handy, but what if we want to run our experiments on a remote machine instead? Maybe you have access to a very powerful GPU machine on-site, or you have some budget to use cloud GPUs. This is where the ClearML Agent comes into play. Check out what the agent can do here:</p>
<ul>
<li><a href="https://youtu.be/MX3BrXnaULs">YouTube video</a></li>
<li><a href="https://clear.ml/docs/latest/docs/clearml_agent">Documentation</a></li>
</ul>
<p>In short: every experiment tracked by the experiment manager contains enough information to reproduce it on a different machine (installed packages, uncommitted changes etc.). So a ClearML agent does just that: it listens to a queue for incoming tasks and when it finds one, it recreates the environment and runs it while still reporting scalars, plots etc. to the experiment manager.</p>
<p>You can turn any machine (a cloud VM, a local GPU machine, your own laptop ... ) into a ClearML agent by simply running:</p>
<div class="fragment"><div class="line">clearml-agent daemon --queue &lt;queues_to_listen_to&gt; [--docker]</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md74"></a>
Cloning, Editing And Enqueuing</h2>
<p>With our agent running, we can give it some work. Remember from the HPO section that we can clone a task and edit the hyperparameters? We can do that from the interface too!</p>
<p>ü™Ñ Clone the experiment by right-clicking it</p>
<p>üéØ Edit the hyperparameters to what you wish them to be</p>
<p>‚è≥ Enqueue the task to any of the queues by right-clicking it</p>
<p><img src="https://github.com/thepycoder/clearml_screenshots/raw/main/enqueue.gif" alt="Enqueue a task from the UI" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md75"></a>
Executing A Task Remotely</h2>
<p>Now you can clone a task like we explained above, or simply mark your current script by adding <code>task.execute_remotely()</code> and on execution it will be put into a queue, for the agent to start working on!</p>
<p>To run the YOLOv5 training script remotely, all you have to do is add this line to the training.py script after the clearml logger has been instantiated:</p>
<div class="fragment"><div class="line"><span class="comment"># ...</span></div>
<div class="line"><span class="comment"># Loggers</span></div>
<div class="line">data_dict = <span class="keywordtype">None</span></div>
<div class="line"><span class="keywordflow">if</span> RANK <span class="keywordflow">in</span> {-1, 0}:</div>
<div class="line">    loggers = Loggers(save_dir, weights, opt, hyp, LOGGER)  <span class="comment"># loggers instance</span></div>
<div class="line">    <span class="keywordflow">if</span> loggers.clearml:</div>
<div class="line">        loggers.clearml.task.execute_remotely(queue=<span class="stringliteral">&quot;my_queue&quot;</span>)  <span class="comment"># &lt;------ ADD THIS LINE</span></div>
<div class="line">        <span class="comment"># Data_dict is either None is user did not choose for ClearML dataset or is filled in by ClearML</span></div>
<div class="line">        data_dict = loggers.clearml.data_dict</div>
<div class="line"><span class="comment"># ...</span></div>
</div><!-- fragment --><p>When running the training script after this change, python will run the script up until that line, after which it will package the code and send it to the queue instead!</p>
<h2><a class="anchor" id="autotoc_md76"></a>
Autoscaling workers</h2>
<p>ClearML comes with autoscalers too! This tool will automatically spin up new remote machines in the cloud of your choice (AWS, GCP, Azure) and turn them into ClearML agents for you whenever there are experiments detected in the queue. Once the tasks are processed, the autoscaler will automatically shut down the remote machines, and you stop paying!</p>
<p>Check out the autoscalers getting started video below.</p>
<p><a href="https://youtu.be/j4XVMAaUt3E"><img src="https://img.youtube.com/vi/j4XVMAaUt3E/0.jpg" alt="Watch the video" class="inline"/></a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
